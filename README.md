# QDDモーター特性モデリングツール

## 概要

このアプリケーションは、QDD（Quasi-Direct Drive）モーターの性能特性を詳細に分析し、3Dグラフで視覚化するためのGUIツールです。

ユーザーはモーターの物理パラメータや動作条件を入力することで、広範な電流・回転数範囲におけるトルク、効率、出力パワーなどを高精度に計算できます。

## 主な機能

- **詳細なモーターモデル**: 銅損、鉄損、ドライバ損失、ギア損失を考慮し、現実的な性能を予測します。
- **性能の3D可視化**: 電流と回転数を軸に、トルク、効率、出力パワーなどの関係性をインタラクティブな3Dマップとして表示します。
- **3Dモデル生成**: パラメータに基づき、インナーローター、アウターローター、アキシャルフラックス型のモーターの3Dモデル（STEPファイル）を生成します。
- **Fusion 360連携**: パラメータをAutodesk Fusion 360にインポート可能なCSV形式でエクスポートできます。
- **データ管理**: パラメータ設定をJSONファイルで保存・読込可能。計算結果のサマリーやグラフ画像も簡単に出力できます。
- **多言語対応**: UIの表示言語を日本語と英語で切り替え可能（`settings.toml`で設定）。
- **UI改善**: パラメータパネルに縦横のスクロールバーが追加され、多くのパラメータを快適に編集できます。

## 動作要件

- **Python**: 3.11 以上
- **ライブラリ**:
    - `matplotlib`
    - `numpy`
    - `pydantic`
    - `cadquery` (3Dモデル生成に必要)
    - `pytest` (テスト実行時)
    - `tkinter` (Python標準ライブラリ)

## インストール

1.  このリポジトリをクローンまたはダウンロードします。
2.  ターミナルでプロジェクトのルートディレクトリに移動し、`pip` を使って依存ライブラリをインストールします。

    ```bash
    # プロジェクトのルートディレクトリで実行
    pip install .
    ```

## 使い方

### GUI版

プロジェクトのルートディレクトリで以下のコマンドを実行すると、GUIアプリケーションが起動します。

```bash
python run_app.py
```

起動後、左側のパネルでモーターのパラメータを調整し、「計算＆プロット」ボタンを押すと、分析が実行され、結果が右側のグラフに表示されます。

**新機能:**
- **3Dモデル生成**: 「3Dモデル生成」ボタンを押すと、現在のパラメータに基づいたモーターのSTEPファイルが生成されます。インナーローター、アウターローター、アキシャルフラックスの各タイプに対応しています。
- **Fusion 360用CSV出力**: 「Fusion用CSV出力」ボタンを押すと、パラメータをFusion 360で利用できるCSVファイルとして保存できます。

### CLI版

`run_cli.py` を使用すると、コマンドラインからパラメータファイルを読み込んで計算を実行し、結果をJSONファイルに出力できます。

**実行例**

```bash
python run_cli.py examples/default.json --out results.json
```

## 設定

プロジェクトのルートにある `settings.toml` ファイルを編集することで、アプリケーションの挙動（UI言語、ウィンドウサイズなど）をカスタマイズできます。

## テスト

テストを実行するには、まず `pytest` をインストールします。

```bash
pip install pytest
```

その後、プロジェクトのルートディレクトリで以下のコマンドを実行します。

```bash
pytest
```

## パラメータ一覧

<details>
<summary>パラメータ一覧（クリックで展開）</summary>

GUIの左パネルから以下のパラメータを入力できます。

| カテゴリ | パラメータ名 | 説明 |
|:---|:---|:---|
| **一般** | `名前` | モデルの任意の名前 |
| | `説明` | モデルに関するメモ |
| | `モータータイプ` | `inner_rotor`, `outer_rotor`, `axial_flux` から選択 |
| **電気特性** | `KV値 [rpm/V]` | モーターの速度定数 |
| | `ヒステリシス係数` | ヒステリシス損の係数 |
| | `渦電流係数` | 渦電流損の係数 |
| **巻線** | `一相あたり抵抗 (25℃) [Ohm]` | 基準温度(25℃)での巻線抵抗 |
| | `一相あたりインダクタンス [H]` | 巻線のインダクタンス |
| | `配線方式` | `star` (スター結線) または `delta` (デルタ結線) |
| | `連続電流 [A]` | モーターが連続して流せる電流 |
| | `ピーク電流 [A]` | モーターが短時間流せる最大電流 |
| | `ワイヤ直径 [mm]` | エナメル線の直径 |
| | `コイル巻数` | 1コイルあたりの巻数 |
| **磁石** | `極対数` | モーターの磁極のペア数 |
| | `ハルバッハ配列` | ハルバッハ配列を使用するかどうか |
| | `磁石幅 [mm]` | 磁石の幅 |
| | `磁石厚さ [mm]` | 磁石の厚さ |
| | `磁石長さ [mm]` | 磁石の長さ |
| | `残留磁束密度 (Br) [T]` | 磁石の残留磁束密度 |
| **ジオメトリ** | `モーター外径 [mm]` | モーターの全体の外径 |
| | `モーター内径 [mm]` | モーターの全体の内径 |
| | `モーター長さ [mm]` | モーターの軸方向の長さ |
| | `スロット数` | ステーターのスロット数 |
| | `スロット深さ [mm]` | スロットの深さ |
| | `スロット開口部幅 [mm]` | スロットの開口部の幅 |
| | `スロット底部幅 [mm]` | スロットの底部の幅 |
| **熱モデル** | `周囲温度 [°C]` | モーターが置かれている環境の温度 |
| | `モーター熱抵抗 [°C/W]` | モーターから周囲への熱の伝わりにくさ |
| **ドライバ損失** | `ドライバON抵抗 [Ohm]` | ドライバFETのON抵抗 |
| | `ドライバ固定損失 [W]` | 電流に依存しないドライバの固定損失 |
| **ギア損失** | `減速比` | ギアボックスの減速比 |
| | `ギア効率` | ギアボックスの伝達効率 (0~1] |
| **シミュレーション** | `バス電圧 [V]` | システムの電源電圧 |

</details>

## ライセンス

このプロジェクトは GNU General Public License v2.0 の下で公開されています。詳細は `LICENSE` ファイルをご覧ください。