# QDDモーター特性モデリングツール

## 概要

このアプリケーションは、QDD（Quasi-Direct Drive）モーターの性能特性を詳細に分析し、3Dグラフで視覚化するためのGUIツールです。

ユーザーはモーターの物理パラメータや動作条件を入力することで、広範な電流・回転数範囲におけるトルク、効率、出力パワー、内部温度などを高精度に計算できます。

## 主な機能

- **詳細なモーターモデル**: 銅損、鉄損、ドライバ損失、ギア損失を考慮し、巻線抵抗への熱フィードバックも行うことで、現実的な性能を予測します。
- **性能の3D可視化**: 電流と回転数を軸に、トルク、効率、出力パワーなどの関係性をインタラクティブな3Dマップとして表示します。
- **データ管理**: パラメータ設定をJSONファイルで保存・読込可能。計算結果のサマリーやグラフ画像も簡単に出力できます。

## 動作要件

- **Python**: 3.11 以上
- **ライブラリ**:
    - `matplotlib >= 3.10.7`
    - `numpy >= 2.3.4`
    - `pydantic >= 2.12.3`
    - `pytest >= 8.4.2` (テスト実行時)
    - `tkinter` (Python標準ライブラリ)

## インストール

1.  このリポジトリをクローンまたはダウンロードします。
2.  ターミナルでプロジェクトのルートディレクトリに移動し、`pip` を使って依存ライブラリをインストールします。

    ```bash
    # プロジェクトのルートディレクトリで実行
    pip install .
    ```

## 使い方

### GUI版

プロジェクトのルートディレクトリで以下のコマンドを実行すると、GUIアプリケーションが起動します。

```bash
python run_app.py
```

起動後、左側のパネルでモーターのパラメータを調整し、「計算＆プロット」ボタンを押すと、分析が実行され、結果が右側のグラフに表示されます。

### CLI版

`run_cli.py` を使用すると、コマンドラインからパラメータファイルを読み込んで計算を実行し、結果をJSONファイルに出力できます。これにより、計算の自動化やバッチ処理が可能です。

**引数**
- `preset`: 必須。パラメータが記述されたプリセットJSONファイルのパス。
- `--out`: オプション。計算結果の出力先JSONファイルのパス（デフォルト: `results.json`）。

**実行例**

```bash
python run_cli.py path/to/your_preset.json --out output/motor_a_results.json
```

## ヘルパースクリプト

### 概算巻線設計スクリプト (`ohm_calc.py`)

このスクリプトは、モーターの巻き直しを検討する際に、目標とするKV値に基づいた新しい巻線の仕様（ワイヤー直径、全長、抵抗、インダクタンス）を**概算**するための補助ツールです。

基準となるモーターのパラメータ（内蔵プロファイルまたはカスタムファイル）と、目標モーターのパラメータを比較し、スケーリング則に基づいて計算します。

**使い方**

```bash
# 書式
python ohm_calc.py <ターゲットのプリセット.json> --density <電流密度> [--profile <プロファイル名> | --reference <基準プリセット.json>]
```

- **引数**:
    - `target_preset_path`: 必須。計算したいモーターのパラメータ（少なくとも`kv`と`peak_current`を含む）を記述したJSONファイルのパス。
    - `--density`: 必須。目標とする電流密度 (A/mm²)。
    - `--profile`: オプション。`min`, `small`, `medium`, `large`, `max`から内蔵の基準プロファイルを選択します。
    - `--reference`: オプション。カスタムのJSONファイルを基準として使用します。
    - `profile`と`reference`がどちらも指定されない場合、デフォルトで`medium`プロファイルが基準として使われます。

- **実行例**:
    ```bash
    # my_motor.json を、smallプロファイルを基準に、電流密度 10.0 A/mm^2 で再計算
    python ohm_calc.py my_motor.json --density 10.0 --profile small
    ```

- **出力例**:
    ```
    --- Approximate Winding Calculation (with ±10% Reference Uncertainty) ---
    ... (計算結果) ...
    CALCULATED PROPERTIES FOR TARGET MOTOR:
      - Est. Wire Diameter:    0.892 mm (This value is independent of reference uncertainty)
      - Est. Total Length:     28.10 - 34.34 m
      - Est. Phase Resistance:  0.5961 - 0.7286 Ohm
      - Est. Phase Inductance:  177.15 - 216.58 uH
    ------------------------------------------------------------
    ```

- **【重要】注意書き**:
    - このスクリプトの計算結果は、多くの物理的な仮定（例：基準モーターとターゲットモーターの形状が同一である、など）に基づいた**概算値**です。
    - あくまで設計の「あたりをつける」ための補助ツールとしてご利用ください。

## テスト

テストを実行するには、まず `pytest` をインストールします。

```bash
pip install pytest
```

その後、プロジェクトのルートディレクトリで以下のコマンドを実行します。

```bash
pytest
```

## パラメータ一覧

<details>
<summary>パラメータ一覧（クリックで展開）</summary>

GUIの左パネルから以下のパラメータを入力できます。

| カテゴリ | パラメータ名 | 説明 |
|:---|:---|:---|
| **モーター基本特性** | `KV値 [rpm/V]` | モーターの速度定数 |
| | `一相あたり抵抗 (25℃) [Ohm]` | 基準温度(25℃)での巻線抵抗 |
| | `一相あたりインダクタンス [H]` | 巻線のインダクタンス |
| | `極対数` | モーターの磁極のペア数 |
| | `配線方式` | `star` (スター結線) または `delta` (デルタ結線) |
| | `連続電流 [A]` | モーターが連続して流せる電流 |
| | `ピーク電流 [A]` | モーターが短時間流せる最大電流 |
| **熱モデル** | `周囲温度 [°C]` | モーターが置かれている環境の温度 |
| | `モーター熱抵抗 [°C/W]` | モーターから周囲への熱の伝わりにくさ |
| **鉄損モデル** | `ヒステリシス係数 [W/rpm]` | ヒステリシス損の係数 |
| | `渦電流係数 [W/rpm^2]` | 渦電流損の係数 |
| **ドライバ損失モデル** | `ドライバON抵抗 [Ohm]` | ドライバFETのON抵抗 |
| | `ドライバ固定損失 [W]` | 電流に依存しないドライバの固定損失 |
| **ギア損失モデル** | `減速比` | ギアボックスの減速比 |
| | `ギア効率` | ギアボックスの伝達効率 (0~1] |
| **動作条件** | `バス電圧 [V]` | システムの電源電圧 |

</details>

## ライセンス

このプロジェクトは GNU General Public License v2.0 の下で公開されています。詳細は `LICENSE` ファイルをご覧ください。